FROM debian:bookworm-slim

# Install runtime dependencies and precompiled gRPC/protobuf
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Runtime libs
    ca-certificates \
    libssl3 \
    # Install gRPC/protobuf from packages (MUCH faster)
    libgrpc++-dev \
    libprotobuf-dev \
    protobuf-compiler-grpc \
    # MQTT libs from packages
    libpaho-mqtt-dev \
    libpaho-mqttpp-dev \
    # Build tools (only what we need)
    g++ \
    cmake \
    make \
    && rm -rf /var/lib/apt/lists/*

# Build application only
WORKDIR /app
COPY . .

# Single build step - much faster
RUN cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_STANDARD=20 \
    && cmake --build build --parallel 2

# Defaults
ENV PONEGLYPH_MASTER_URL=http://master:8080
ENV PONEGLYPH_USE_GRPC=1
ENV PONEGLYPH_MASTER_GRPC=master:50051

CMD ["./build/Poneglyph"]