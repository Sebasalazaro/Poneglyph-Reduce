# Use gradle pre-installed
FROM gradle:8.7.0-jdk17 AS build
WORKDIR /home/gradle/project

# Copy first the build files (cache friendly)
COPY build.gradle settings.gradle ./
# Then the code
COPY src ./src
COPY src/main/proto ./src/main/proto

# Build distribution (bin + libs)
RUN gradle --no-daemon clean generateProto installDist

FROM eclipse-temurin:17-jre
WORKDIR /app
# Thanks to settings.gradle, the name of the dist is "road-poneglyph"
COPY --from=build /home/gradle/project/build/install/road-poneglyph /app
EXPOSE 8080 50051
ENV GRPC_PORT=50051
# script generated by 'installDist' according to settings.gradle
CMD ["./bin/road-poneglyph"]
